---

# 作業計画書（2026-01-15）: SCPデータ取得MCPサーバ（SCP-MCP）実装

## 参照ドキュメント（SSoT）

- `docs/要件定義.md`
  - 1. 背景・目的
  - 2. 対象範囲
  - 3. データソース要件
  - 4. ライセンス・コンプライアンス要件
  - 5. 機能要件（Tools/Resources/Prompts/Transport）
  - 6. コンテンツ正規化要件
  - 7. 検索要件
  - 8. セキュリティ要件
  - 9. 非機能要件
  - 10. 受入基準

## 目的

SCP Data API を一次ソースとして、MCPクライアントから「検索・取得・引用」できるSCP-MCPサーバを実装する。

## 非目的（本計画では実施しない）

- 永続DB/オブジェクトストレージへのミラー運用（`docs/要件定義.md` 2.2）
- SCP Wikiのアカウント操作（投稿/編集/投票）（`docs/要件定義.md` 2.2）
- 画像ファイルそのものの配信（URL提示まで）（`docs/要件定義.md` 2.2）

## 進め方（t-wada式TDD）

- 各要件（特にTools）ごとに **Red → Green → Refactor** を最小ステップで回す。
- テストが落ちている状態でのリファクタはしない。
- `skip`/`only` は恒久化しない。

## 作業項目（チェックは完了時に [✓]）

- [✓] プロジェクト雛形（Node.js/TypeScript、テスト基盤、lint/format最小）を作成（要件: 5.1, 9）
- [✓] SCP Data API クライアント（許可リスト/SSRF対策、ETag/If-Modified-Since相当のメモリキャッシュ）を実装（要件: 3.1, 3.3, 8）
- [✓] 検索基盤（全文: title+本文、フィルタ: tags/series/created_at/rating、スコアリング: BM25等）を実装（要件: 7, 5.2-1）
- [✓] `scp_search` を実装（license/attribution必須、limit尊重、snippet生成）（要件: 5.2-1, 4, 10）
- [✓] `scp_get_page` を実装（link/scp_number/page_id、メタデータ返却、license/attribution必須）（要件: 5.2-2, 4, 10）
- [✓] `scp_get_content` を実装（format: markdown|text|html|wikitext、正規化、content_is_untrustedメタ）（要件: 5.2-3, 6, 8）
- [✓] `scp_get_related` を実装（references/hubsから関連抽出、relation_type付与）（要件: 5.2-4）
- [✓] `scp_get_attribution` を実装（CC BY-SA 3.0準拠の帰属テンプレ生成）（要件: 5.2-5, 4）
- [✓] Prompts（`prompt_quote_with_citation` / `prompt_rag_reader`）を実装（要件: 5.4）
- [✓] Resources（ページ/本文参照の最小セット）を実装（要件: 5.1）
- [✓] Transport を実装（stdio + Streamable HTTP、HTTPはhealth checkを提供）（要件: 5.1, 9）
- [✓] セキュリティ（rate limit、監査ログ、非信頼データメタ）を実装（要件: 8）
- [✓] README を要件に合わせて整備（非公式、ライセンス遵守注意を明記）（要件: 4.3）
- [✓] 受入基準（tools/list→tools/call、stdio/HTTP双方）を確認（要件: 10）

## 検証コマンド（予定）

- `npm test`
- `npm run build`
- `npm run mcp:stdio`（stdio起動）
- `npm run mcp:http`（HTTP起動）

## リスク/注意点

- SCP Data API の `index.json` / `content_*.json` は大きいため、メモリ使用量とレスポンス時間に注意する（キャッシュ/検索インデックスの保持範囲を必要最小限にする）。
- SCP本文は非信頼データ（prompt injection を含み得る）として扱い、出力に明示する（要件: 8）。
